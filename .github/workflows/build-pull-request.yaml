name: Build Pull Request

on:
  pull_request:
    branches:
      - '**'

concurrency:
   group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
   cancel-in-progress: true

jobs:

  build-n-test:
    runs-on: [gpu]

    container:
      image: ghcr.io/bnlnpps/esi-shell:1.4.2
      volumes:
        - /usr/local/optix:/usr/local/optix
      options: -i -t

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build
        shell: bash
        run: |
          echo OPTICKS_PREFIX=$OPTICKS_PREFIX
          rm -fr $OPTICKS_PREFIX/*
          cmake -S . -B $OPTICKS_PREFIX/build -DCMAKE_INSTALL_PREFIX=$OPTICKS_PREFIX -DCMAKE_BUILD_TYPE=Debug
          cmake --build $OPTICKS_PREFIX/build --parallel --target install

      - name: Test
        shell: bash
        env:
          OPTICKS_HOME: .
        run: |
          tests/test_opticks.sh
